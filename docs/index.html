<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nexus OS | Dynamic Core</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script> 
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: { fontFamily: { sans: ['Inter', 'sans-serif'] }, extend: { colors: { brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' } } } }
        }
    </script>
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none;  scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(2px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen w-full flex overflow-hidden selection:bg-brand-500 selection:text-white">

    <div id="app" class="flex w-full h-full"></div>
    <div id="toasts" class="absolute bottom-6 right-6 flex flex-col gap-2 pointer-events-none z-[100]"></div>

    <script>
        // --- 1. CONFIGURATION ( The "DNA" of the App ) ---
        const CONFIG = {
            apiBase: "https://mkwhatsapp.onrender.com",
            nodes: [
                { id: 'client-1', label: 'NODE 1' },
                { id: 'client-2', label: 'NODE 2' }
            ],
            nav: [
                { id: 'dashboard', label: 'Dashboard', icon: 'layout-grid' },
                { id: 'campaigns', label: 'Campaigns', icon: 'megaphone' },
                { id: 'contacts', label: 'Contacts', icon: 'book-user' },
                { id: 'settings', label: 'Config', icon: 'settings' }
            ]
        };

        // --- 2. REACTIVE STATE ENGINE ( The "Brain" ) ---
        // This Proxy automatically updates the UI when data changes.
        const handler = {
            set(target, key, value) {
                target[key] = value;
                // Specific Reactivity Hooks
                if (key === 'route') Render.view();
                if (key === 'user') { Render.sidebar(); Session.check(); }
                if (key === 'queue' || key === 'processedCount') Render.header(); // Auto-update counters
                return true;
            }
        };

        const State = new Proxy({
            user: 'client-1',
            route: 'dashboard',
            status: 'OFFLINE',
            queue: [],
            processedCount: 0,
            allContacts: [],
            selection: new Set(),
            settings: { batch: 20, cool: 60 },
            activeFile: null
        }, handler);

        // --- 3. VIRTUAL DOM HELPER ( The "Builder" ) ---
        // Generates secure HTML elements dynamically
        const h = (tag, classes, content, props = {}) => {
            const el = document.createElement(tag);
            if (classes) el.className = classes;
            if (content) {
                if (Array.isArray(content)) content.forEach(c => el.appendChild(c));
                else if (content instanceof HTMLElement) el.appendChild(content);
                else el.textContent = content; // Secure text rendering
            }
            Object.entries(props).forEach(([k, v]) => {
                if (k.startsWith('on')) el.addEventListener(k.substring(2).toLowerCase(), v);
                else if (k === 'html') el.innerHTML = v; // Only use if strictly needed
                else el.setAttribute(k, v);
            });
            return el;
        };

        // --- 4. RENDERER ( The "Painter" ) ---
        const Render = {
            init() {
                const app = document.getElementById('app');
                app.innerHTML = '';
                // 1. Sidebar (Fixed)
                app.appendChild(this.sidebarComponent());
                // 2. Main Content Area
                const main = h('main', 'flex-1 relative flex flex-col h-full overflow-hidden bg-white md:bg-slate-50/30 transition-all', [
                    this.headerComponent(),
                    h('div', 'flex-1 overflow-y-auto p-4 md:p-6 relative no-scrollbar', [], { id: 'view-container' })
                ]);
                app.appendChild(main);
                this.view(); // Render initial view
            },

            sidebarComponent() {
                // Dynamic Node Buttons
                const nodeButtons = CONFIG.nodes.map(n => 
                    h('button', `py-2 text-[10px] font-bold rounded-lg border transition-all ${State.user === n.id ? 'border-brand-600 bg-brand-600 text-white shadow-md' : 'border-slate-200 bg-white text-slate-500 hover:bg-slate-50'}`, n.label, {
                        onClick: () => State.user = n.id
                    })
                );

                // Dynamic Nav Items
                const navItems = CONFIG.nav.map(n => 
                    h('button', `w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-xs font-semibold transition-all ${State.route === n.id ? 'bg-brand-50 text-brand-600' : 'text-slate-500 hover:bg-slate-100'}`, [
                        h('i', '', '', { 'data-lucide': n.icon, class: 'w-4 h-4' }),
                        h('span', '', n.label)
                    ], { onClick: () => State.route = n.id })
                );

                // Re-render Sidebar logic if it already exists (for updates)
                const existing = document.getElementById('sidebar-content');
                if(existing) { existing.replaceWith(this.sidebarInner(nodeButtons, navItems)); lucide.createIcons(); return; }

                return h('aside', 'hidden md:flex w-72 bg-white border-r border-slate-200 flex-col z-50 shadow-2xl md:shadow-none', 
                    this.sidebarInner(nodeButtons, navItems)
                , { id: 'sidebar' });
            },

            sidebarInner(nodes, nav) {
                return h('div', 'flex flex-col h-full', [
                    h('div', 'h-16 flex items-center px-6 border-b border-slate-100 shrink-0', [
                        h('div', 'w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center text-white mr-3 shadow-lg', 
                            h('i', '', '', { 'data-lucide': 'layers', class: 'w-5 h-5' })
                        ),
                        h('div', '', [
                            h('h1', 'font-bold text-lg tracking-tight leading-none', 'Nexus OS'),
                            h('span', 'text-[10px] font-bold text-slate-400 uppercase tracking-widest', 'Enterprise')
                        ])
                    ]),
                    h('div', 'flex-1 p-4 overflow-y-auto space-y-6', [
                        h('div', 'bg-slate-50 rounded-xl p-4 border border-slate-100', [
                            h('div', 'flex justify-between mb-3', [
                                h('span', 'text-[10px] uppercase font-bold text-slate-400 tracking-wider', 'Session Manager'),
                                h('span', `w-2 h-2 rounded-full transition-colors duration-300 ${State.status === 'READY' ? 'bg-emerald-500 shadow-[0_0_8px_#10b981]' : 'bg-slate-300'}`, '', { id: 'conn-dot' })
                            ]),
                            h('div', 'grid grid-cols-2 gap-2 mb-3', nodes),
                            h('div', '', [], { id: 'action-area' }) // Dynamic Action Area
                        ]),
                        h('nav', 'space-y-1', nav)
                    ])
                ], { id: 'sidebar-content' });
            },

            headerComponent() {
                // Header auto-updates via reactive state, but we build the shell here
                return h('header', 'h-16 px-4 md:px-8 bg-white border-b border-slate-200 flex items-center justify-between shrink-0 z-30', [
                    h('div', 'flex items-center gap-3', [
                        h('h2', 'text-lg md:text-xl font-bold text-slate-800', State.route.charAt(0).toUpperCase() + State.route.slice(1), { id: 'page-title' })
                    ]),
                    h('div', 'px-3 py-1.5 bg-slate-50 border border-slate-200 rounded-full text-xs font-bold text-slate-600 shadow-sm flex items-center gap-2', [
                        h('span', `w-2 h-2 rounded-full ${State.queue.length > 0 ? 'bg-emerald-500 animate-pulse' : 'bg-slate-300'}`, ''),
                        h('span', '', `Queue: ${State.queue.length}`, { id: 'queue-badge' })
                    ])
                ], { id: 'app-header' });
            },

            // --- VIEW ROUTER ---
            view() {
                const container = document.getElementById('view-container');
                container.innerHTML = ''; // Clear current view
                
                // Update Sidebar Highlights
                this.sidebarComponent(); 
                document.getElementById('page-title').textContent = State.route.charAt(0).toUpperCase() + State.route.slice(1);

                // Inject View Content
                let content;
                switch(State.route) {
                    case 'dashboard': content = this.viewDashboard(); break;
                    case 'campaigns': content = this.viewCampaigns(); break;
                    case 'contacts': content = this.viewContacts(); break;
                    case 'settings': content = this.viewSettings(); break;
                    default: content = h('div', '', '404 Not Found');
                }
                container.appendChild(content);
                lucide.createIcons();
            },

            // --- HEADER RE-RENDERER (Optimized) ---
            header() {
                const badge = document.getElementById('queue-badge');
                if(badge) badge.textContent = `Queue: ${State.queue.length}`;
            },

            // --- DYNAMIC VIEWS GENERATORS ---
            viewDashboard() {
                return h('div', 'max-w-6xl mx-auto space-y-6 fade-in', [
                    h('div', 'grid grid-cols-1 md:grid-cols-3 gap-4', [
                        this.statCard('users', 'Global Contacts', State.allContacts.length),
                        this.statCard('send', 'Total Sent', State.processedCount),
                        this.statCard('shield', 'System Status', 'Active', 'text-amber-500')
                    ]),
                    h('div', 'bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden', [
                        h('div', 'px-6 py-4 border-b border-slate-100 bg-slate-50/50', h('h3', 'font-bold text-sm text-slate-700', 'Recent Activity')),
                        h('div', 'p-8 text-center text-xs text-slate-400 italic', 'System Ready.')
                    ])
                ]);
            },

            viewCampaigns() {
                return h('div', 'flex flex-col md:flex-row gap-6 h-full fade-in', [
                    h('div', 'w-full md:w-[400px] flex flex-col gap-4', [
                        h('div', 'bg-white border border-slate-200 p-5 rounded-xl shadow-sm flex-1', [
                            h('h3', 'font-bold text-slate-700 text-sm mb-4', 'Target Audience'),
                            h('textarea', 'w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-xs font-mono outline-none focus:border-brand-500 h-32 mb-4', '', { id: 'camp-input', placeholder: 'Enter numbers...' }),
                            h('input', 'w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-xs outline-none focus:border-brand-500', '', { id: 'camp-msg', placeholder: 'Message...' })
                        ]),
                        h('button', 'w-full py-3 bg-slate-800 text-white rounded-xl font-bold shadow-lg hover:bg-slate-900 transition-all flex justify-center gap-2', [
                            h('i', '', '', { 'data-lucide': 'plus', class: 'w-4 h-4' }), ' Add to Queue'
                        ], { onClick: Engine.queue })
                    ]),
                    h('div', 'flex-1 bg-white border border-slate-200 rounded-xl flex flex-col overflow-hidden shadow-sm h-[400px]', [
                        h('div', 'h-14 border-b border-slate-100 flex items-center justify-between px-5 bg-slate-50/50', [
                            h('span', 'text-xs font-bold text-slate-500 uppercase', 'Dispatcher'),
                            h('button', 'text-[10px] font-bold px-4 py-1.5 rounded-lg bg-emerald-100 text-emerald-700 hover:bg-emerald-200', 'START', { id: 'btn-engine-toggle', onClick: Engine.toggle })
                        ]),
                        h('div', 'flex-1 overflow-y-auto p-4 space-y-2 font-mono text-xs', [], { id: 'console-logs' })
                    ])
                ]);
            },

            viewContacts() {
                return h('div', 'flex flex-col md:flex-row gap-6 h-full fade-in', [
                    h('div', 'flex-1 bg-white border border-slate-200 rounded-xl shadow-sm flex flex-col overflow-hidden', [
                        h('div', 'p-3 border-b border-slate-100 flex gap-2', [
                            h('button', 'px-3 bg-white border border-slate-200 hover:bg-slate-50 text-slate-600 rounded-lg', [
                                h('i', '', '', { 'data-lucide': 'refresh-cw', class: 'w-4 h-4' })
                            ], { onClick: ContactManager.sync })
                        ]),
                        h('div', 'flex-1 overflow-y-auto p-2', [], { id: 'contact-list-container' })
                    ]),
                    h('div', 'hidden md:flex flex-col gap-4 w-[320px]', [
                        h('div', 'bg-white p-4 rounded-xl border border-slate-200 shadow-sm', h('h3', 'font-bold text-slate-700 text-sm', 'Saved Lists'))
                    ])
                ]);
            },

            viewSettings() {
                return h('div', 'max-w-xl mx-auto fade-in', [
                    h('div', 'bg-white p-8 rounded-xl border border-slate-200 shadow-sm', [
                        h('h3', 'font-bold text-lg text-slate-800 mb-6', 'Configuration'),
                        h('div', 'space-y-6', [
                            this.rangeControl('Batch Size', 'batch', 5, 50),
                            this.rangeControl('Cool-down (s)', 'cool', 10, 300)
                        ])
                    ])
                ]);
            },

            // --- COMPONENT HELPERS ---
            statCard(icon, title, value, colorClass = 'text-brand-500') {
                return h('div', 'bg-white p-6 rounded-xl border border-slate-200 shadow-sm', [
                    h('div', 'flex items-center gap-3 mb-2', [
                        h('i', '', '', { 'data-lucide': icon, class: `w-4 h-4 ${colorClass}` }),
                        h('span', 'text-xs font-bold text-slate-400 uppercase', title)
                    ]),
                    h('p', 'text-3xl font-bold text-slate-800 tracking-tight', value)
                ]);
            },

            rangeControl(label, key, min, max) {
                return h('div', '', [
                    h('div', 'flex justify-between mb-2', [
                        h('label', 'text-xs font-bold text-slate-600', label),
                        h('span', 'text-xs font-bold text-brand-600', State.settings[key], { id: `val-${key}` })
                    ]),
                    h('input', 'w-full accent-brand-600 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer', '', {
                        type: 'range', min, max, value: State.settings[key],
                        onInput: (e) => { State.settings[key] = e.target.value; document.getElementById(`val-${key}`).textContent = e.target.value; }
                    })
                ]);
            }
        };

        // --- 5. LOGIC MODULES (The Muscles) ---
        const Session = {
            async check() {
                // Logic remains same, but updates State.status proxy
                try {
                    const res = await fetch(`${CONFIG.apiBase}/api/status/${State.user}`);
                    if(res.ok) {
                        const data = await res.json();
                        State.status = data.status;
                        const area = document.getElementById('action-area');
                        if(area) {
                            if(State.status === 'READY') area.innerHTML = `<button class="w-full py-2 bg-red-50 text-red-600 text-xs font-bold rounded-lg" onclick="Session.stop()">Disconnect</button>`;
                            else area.innerHTML = `<button class="w-full py-2 bg-slate-800 text-white text-xs font-bold rounded-lg" onclick="Session.start()">Initialize</button>`;
                        }
                    }
                } catch(e) {}
            },
            async start() { await fetch(`${CONFIG.apiBase}/api/start`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id:State.user})}); this.check(); },
            async stop() { await fetch(`${CONFIG.apiBase}/api/logout`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id:State.user})}); this.check(); }
        };

        const ContactManager = {
            async sync() {
                const res = await fetch(`${CONFIG.apiBase}/api/contacts/${State.user}`, { method:'POST' });
                const data = await res.json();
                if(data && data.contacts) {
                    State.allContacts = data.contacts;
                    this.renderList();
                }
            },
            renderList() {
                const container = document.getElementById('contact-list-container');
                if(!container) return;
                container.innerHTML = '';
                State.allContacts.slice(0, 100).forEach(c => {
                    container.appendChild(h('div', 'p-2 border-b border-slate-100 text-xs text-slate-600', `${c.name} (${c.number})`));
                });
            }
        };

        const Engine = {
            toggle() { State.isRunning = !State.isRunning; document.getElementById('btn-engine-toggle').textContent = State.isRunning ? "PAUSE" : "START"; if(State.isRunning) this.process(); },
            queue() { 
                const raw = document.getElementById('camp-input').value; 
                const nums = raw.match(/\d{10,}/g) || [];
                nums.forEach(n => State.queue.push({ number: n }));
                // Proxy auto-updates UI header
            },
            async process() {
                if(!State.isRunning || !State.queue.length) { State.isRunning = false; return; }
                const item = State.queue.shift();
                document.getElementById('console-logs').prepend(h('div', 'text-slate-500', `> Sending to ${item.number}...`));
                
                await fetch(`${CONFIG.apiBase}/api/send`, { 
                    method: 'POST', 
                    headers: {'Content-Type':'application/json'}, 
                    body: JSON.stringify({ id: State.user, number: item.number, message: document.getElementById('camp-msg').value }) 
                });
                
                State.processedCount++; // Proxy auto-updates Stats
                setTimeout(() => this.process(), 2000);
            }
        };

        // --- 6. BOOTSTRAP ---
        Render.init();
        Session.check();

    </script>
</body>
</html>
