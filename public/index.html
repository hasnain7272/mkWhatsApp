<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus OS | Enterprise SaaS</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script> 
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                fontFamily: { sans: ['Inter', 'sans-serif'] },
                extend: {
                    colors: { 
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' },
                        slate: { 850: '#1e293b', 900: '#0f172a' } 
                    },
                    animation: { 'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
                }
            }
        }
    </script>
    <style>
        body { background: #f8fafc; color: #334155; -webkit-font-smoothing: antialiased; }
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        
        .nav-btn { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 8px; font-size: 13px; font-weight: 500; color: #64748b; transition: all 0.2s; }
        .nav-btn:hover { background: #f1f5f9; color: #0f172a; }
        .nav-btn.active { background: #eff6ff; color: #2563eb; font-weight: 600; }
        
        .input-field { width: 100%; background: #ffffff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px; font-size: 13px; transition: 0.2s; outline: none; }
        .input-field:focus { border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }
        
        .node-btn { flex: 1; padding: 6px; font-size: 11px; font-weight: 700; border-radius: 6px; transition: all 0.2s; text-transform: uppercase; letter-spacing: 0.05em; }
        .node-btn.active { background: #2563eb; color: white; shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2); }
        .node-btn.inactive { background: transparent; color: #64748b; hover:bg-slate-100; hover:text-slate-700; }

        .contact-item { transition: all 0.15s; cursor: pointer; border: 1px solid transparent; user-select: none; }
        .contact-item:hover { background: #f8fafc; border-color: #e2e8f0; }
        
        .contact-item.selected { background: #eff6ff; border-color: #3b82f6; }
        .contact-item.selected h4 { color: #1e40af; } 
        .contact-item.selected p { color: #60a5fa; }   

        .loader { width: 16px; height: 16px; border: 2px solid #e2e8f0; border-bottom-color: #3b82f6; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen w-full flex overflow-hidden">

    <aside class="w-[280px] bg-white border-r border-slate-200 flex flex-col z-30 shadow-[4px_0_24px_rgba(0,0,0,0.02)]">
        <div class="h-16 flex items-center px-6 border-b border-slate-50 shrink-0">
            <div class="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center text-white mr-3 shadow-lg shadow-blue-500/20">
                <i data-lucide="layers" class="w-5 h-5"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg text-slate-800 tracking-tight leading-none">Nexus OS</h1>
                <span class="text-[10px] font-semibold text-slate-400 uppercase tracking-wider">Enterprise</span>
            </div>
        </div>

        <div class="flex-1 p-4 overflow-y-auto space-y-6">
            
            <div class="bg-slate-50 rounded-xl p-4 border border-slate-100">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Active Node</span>
                    <span id="conn-dot" class="w-2 h-2 rounded-full bg-slate-300 transition-colors duration-300"></span>
                </div>
                
                <div class="flex bg-white rounded-lg p-1 border border-slate-200 shadow-sm mb-4">
                    <button onclick="Session.switch('client-1')" id="btn-c1" class="node-btn active">Node 1</button>
                    <button onclick="Session.switch('client-2')" id="btn-c2" class="node-btn inactive">Node 2</button>
                </div>

                <div id="action-area">
                    </div>
            </div>

            <nav class="space-y-1">
                <p class="px-2 text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-2">Modules</p>
                <button onclick="Router.go('dashboard')" id="nav-dashboard" class="nav-btn active"><i data-lucide="layout-grid" class="w-4 h-4"></i> Dashboard</button>
                <button onclick="Router.go('campaigns')" id="nav-campaigns" class="nav-btn"><i data-lucide="megaphone" class="w-4 h-4"></i> Campaigns</button>
                <button onclick="Router.go('contacts')" id="nav-contacts" class="nav-btn"><i data-lucide="book-user" class="w-4 h-4"></i> Contacts</button>
                <button onclick="Router.go('settings')" id="nav-settings" class="nav-btn"><i data-lucide="settings" class="w-4 h-4"></i> Config</button>
            </nav>
        </div>

        <div class="p-4 border-t border-slate-100 bg-slate-50/50 shrink-0">
            <div class="flex justify-between items-center mb-2">
                <span class="text-[10px] font-bold text-slate-500 uppercase">Engine Status</span>
                <span id="engine-state" class="text-[10px] font-bold text-slate-400">IDLE</span>
            </div>
            <div class="w-full bg-slate-200 h-1.5 rounded-full overflow-hidden">
                <div id="global-progress" class="h-full bg-brand-600 w-0 transition-all duration-300"></div>
            </div>
        </div>
    </aside>

    <main class="flex-1 relative bg-slate-50/50 flex flex-col overflow-hidden">
        
        <header class="h-16 px-8 bg-white border-b border-slate-200 flex items-center justify-between shrink-0">
            <h2 id="page-title" class="text-xl font-bold text-slate-800">Dashboard</h2>
            <div class="flex items-center gap-4">
                <div class="px-3 py-1 bg-white border border-slate-200 rounded-full text-xs font-medium text-slate-600 shadow-sm flex items-center gap-2">
                    <span class="w-1.5 h-1.5 rounded-full bg-brand-500"></span> Queue: <span id="queue-count" class="font-bold text-brand-600">0</span>
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8 relative">

            <div id="modal-qr" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-900/10 backdrop-blur-sm animate-fade">
                <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center border border-slate-100">
                    <div class="bg-white p-2 border border-slate-100 rounded-xl inline-block mb-4 shadow-sm"><canvas id="qr-canvas"></canvas></div>
                    <h3 class="font-bold text-lg text-slate-800">Link Device</h3>
                    <p class="text-xs text-slate-500 mb-6">Open WhatsApp > Linked Devices > Link a Device</p>
                    <button onclick="document.getElementById('modal-qr').classList.add('hidden')" class="text-xs font-bold text-slate-400 hover:text-slate-600">Hide Overlay</button>
                </div>
            </div>

            <div id="modal-edit" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-900/10 backdrop-blur-sm animate-fade">
                <div class="bg-white p-6 rounded-2xl shadow-2xl max-w-lg w-full border border-slate-100 flex flex-col h-[500px]">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg text-slate-800">Edit List</h3>
                        <button onclick="Database.closeEdit()" class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                    <input type="hidden" id="edit-key-hidden">
                    <p class="text-xs text-slate-500 mb-2">Edit numbers directly (one per line). Names are preserved if format is correct.</p>
                    <textarea id="edit-area" class="flex-1 input-field font-mono text-xs resize-none mb-4 p-4"></textarea>
                    <div class="flex gap-2 shrink-0">
                        <button onclick="Database.saveEdit()" class="flex-1 py-2 bg-brand-600 text-white rounded-lg text-xs font-bold hover:bg-brand-700 transition-colors">Save Changes</button>
                    </div>
                </div>
            </div>

            <div id="view-dashboard" class="max-w-4xl mx-auto space-y-6 animate-fade">
                <div class="grid grid-cols-3 gap-6">
                    <div class="glass-panel bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <div class="flex items-center gap-3 mb-2"><i data-lucide="users" class="w-4 h-4 text-brand-500"></i><span class="text-xs font-bold text-slate-400 uppercase">Total Contacts</span></div>
                        <p id="stat-contacts" class="text-2xl font-bold text-slate-800">0</p>
                    </div>
                    <div class="glass-panel bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <div class="flex items-center gap-3 mb-2"><i data-lucide="check-circle" class="w-4 h-4 text-emerald-500"></i><span class="text-xs font-bold text-slate-400 uppercase">Total Sent</span></div>
                        <p id="stat-sent" class="text-2xl font-bold text-slate-800">0</p>
                    </div>
                    <div class="glass-panel bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <div class="flex items-center gap-3 mb-2"><i data-lucide="shield" class="w-4 h-4 text-amber-500"></i><span class="text-xs font-bold text-slate-400 uppercase">Safe Mode</span></div>
                        <p class="text-2xl font-bold text-slate-800">Active</p>
                    </div>
                </div>
            </div>

            <div id="view-campaigns" class="hidden h-full flex gap-6 animate-fade">
                <div class="w-[380px] flex flex-col gap-4">
                    <div class="bg-white border border-slate-200 p-5 rounded-xl shadow-sm flex-1 flex flex-col">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-slate-700 text-sm">Targets</h3>
                            <select id="list-selector" onchange="Database.loadList(this.value)" class="text-xs bg-slate-50 border border-slate-200 rounded px-2 py-1 outline-none text-slate-600 cursor-pointer hover:border-brand-500">
                                <option value="">Load List...</option>
                            </select>
                        </div>
                        <textarea id="camp-input" class="flex-1 input-field font-mono text-xs resize-none mb-3" placeholder="Paste numbers here (one per line)..."></textarea>
                        <div class="space-y-3">
                            <input id="camp-msg" type="text" class="input-field" placeholder="Message content...">
                            <div onclick="document.getElementById('camp-file').click()" id="file-drop" class="border border-dashed border-slate-300 rounded-lg p-3 flex items-center justify-center gap-2 cursor-pointer hover:bg-slate-50 transition-colors">
                                <i data-lucide="paperclip" class="w-4 h-4 text-slate-400"></i>
                                <span id="file-name" class="text-xs font-bold text-slate-500 truncate max-w-[150px]">Attach Media</span>
                                <input type="file" id="camp-file" class="hidden" onchange="Engine.handleFile(this)">
                            </div>
                        </div>
                    </div>
                    <button onclick="Engine.queue()" class="w-full py-3 bg-brand-600 text-white rounded-xl font-bold shadow-lg hover:bg-brand-700 transition-all flex justify-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> Add to Queue</button>
                </div>
                <div class="flex-1 bg-white border border-slate-200 rounded-xl flex flex-col overflow-hidden shadow-sm">
                    <div class="h-12 border-b border-slate-100 flex items-center justify-between px-5 bg-slate-50/50">
                        <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">Dispatcher Console</span>
                        <div class="flex gap-2">
                            <button onclick="Engine.toggle()" id="btn-engine-toggle" class="text-[10px] font-bold px-3 py-1 rounded bg-emerald-100 text-emerald-700 hover:bg-emerald-200 transition-colors">START</button>
                            <button onclick="Engine.clear()" class="text-[10px] font-bold px-3 py-1 rounded bg-slate-200 text-slate-600 hover:bg-slate-300 transition-colors">CLEAR</button>
                        </div>
                    </div>
                    <div id="console-logs" class="flex-1 overflow-y-auto p-4 space-y-1 font-mono text-xs">
                        <div class="text-center text-slate-400 mt-20 italic">Ready.</div>
                    </div>
                </div>
            </div>

            <div id="view-contacts" class="hidden h-full animate-fade">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 h-full">
                    
                    <div class="bg-white border border-slate-200 rounded-xl shadow-sm flex flex-col overflow-hidden h-full">
                        <div class="p-4 border-b border-slate-100 flex gap-2">
                            <div class="relative flex-1">
                                <i data-lucide="search" class="w-4 h-4 absolute left-3 top-3 text-slate-400"></i>
                                <input type="text" id="contact-search" onkeyup="ContactManager.filter()" placeholder="Search Name or Number..." class="pl-9 w-full input-field">
                            </div>
                            <button onclick="ContactManager.sync()" id="btn-sync-contacts" class="px-3 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg text-xs font-bold flex items-center justify-center" title="Sync from WhatsApp">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <div id="contact-list-container" class="flex-1 overflow-y-auto p-2 space-y-1">
                            <div class="text-center mt-20 text-slate-400 text-xs">Click Sync to load contacts from WhatsApp.</div>
                        </div>
                    </div>

                    <div class="flex flex-col gap-6 h-fit">
                        
                        <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold text-slate-700 text-sm">Create List from Selection</h3>
                                <span id="sel-count" class="bg-brand-100 text-brand-600 text-xs font-bold px-2 py-0.5 rounded-full">0</span>
                            </div>
                            <input type="text" id="new-list-name" placeholder="List Name (e.g. VIP Clients)" class="input-field mb-2">
                            <div class="flex gap-2">
                                <button onclick="ContactManager.saveSelection()" class="flex-1 py-2 bg-brand-600 text-white rounded-lg text-xs font-bold hover:bg-brand-700 transition-colors">Save Selection</button>
                                <button onclick="ContactManager.clearSelection()" class="px-3 py-2 bg-slate-100 text-slate-500 rounded-lg text-xs font-bold hover:bg-slate-200 transition-colors">Clear</button>
                            </div>
                        </div>

                        <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                            <h3 class="font-bold text-slate-800 mb-1 text-sm">Import Group/Broadcast</h3>
                            <p class="text-[10px] text-slate-400 mb-3">Fetch numbers from WhatsApp.</p>
                            <div class="space-y-2">
                                <div class="flex gap-2">
                                    <button onclick="Import.loadGroups()" id="btn-load-groups" class="flex-1 py-2 bg-slate-50 text-slate-600 rounded-lg text-xs font-bold border border-slate-200 hover:bg-slate-100 transition-colors">Load Lists</button>
                                </div>
                                <select id="group-selector" class="input-field bg-slate-50" disabled><option value="">(Load First)</option></select>
                                <button onclick="Import.fetchSelected()" id="btn-import" class="w-full py-2 bg-slate-800 text-white rounded-lg text-xs font-bold hover:bg-slate-900 transition-colors opacity-50 cursor-not-allowed" disabled>Import Selected</button>
                            </div>
                        </div>

                        <div class="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex flex-col max-h-[300px]">
                            <h3 class="font-bold text-slate-700 text-sm mb-3">Saved Lists</h3>
                            <div id="contact-grid" class="flex-1 overflow-y-auto space-y-2 pr-1"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-settings" class="hidden max-w-xl mx-auto animate-fade">
                <div class="bg-white p-8 rounded-xl border border-slate-200 shadow-sm">
                    <h3 class="font-bold text-lg text-slate-800 mb-6">Safety Config</h3>
                    <div class="space-y-6">
                        <div><label class="text-sm font-bold text-slate-600">Batch Size</label><input type="range" min="5" max="50" value="20" class="w-full accent-blue-600 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" oninput="Settings.save('batch', this.value)"></div>
                        <div><label class="text-sm font-bold text-slate-600">Cool-down</label><input type="range" min="10" max="300" value="60" class="w-full accent-blue-600 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" oninput="Settings.save('cool', this.value)"></div>
                    </div>
                </div>
            </div>
        </div>
        <div id="toasts" class="absolute bottom-6 right-6 flex flex-col gap-2 pointer-events-none z-[60]"></div>
    </main>

    <script>
        lucide.createIcons();
        const State = { user: 'client-1', status: 'OFFLINE', qr: null, queue: [], activeFile: null, isRunning: false, processedCount: 0, settings: { batch: 20, cool: 60 }, contacts: [], selection: new Set() };
        
        const Utils = {
            sleep: (ms) => new Promise(r => setTimeout(r, ms)),
            processFile: async (file) => {
                if (file.name.toLowerCase().endsWith('.heic')) {
                    const blob = await heic2any({ blob: file, toType: "image/jpeg", quality: 0.7 });
                    file = new File([Array.isArray(blob)?blob[0]:blob], file.name.replace(/\.heic$/i, ".jpg"), { type: "image/jpeg" });
                }
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve({ mimetype: file.type, data: reader.result.split(',')[1], filename: file.name });
                });
            },
            toast: (msg, type='info') => {
                const c = document.getElementById('toasts');
                const el = document.createElement('div');
                el.className = `${type === 'success' ? 'bg-emerald-600' : type === 'error' ? 'bg-red-500' : 'bg-slate-800'} text-white px-4 py-3 rounded-lg shadow-lg text-xs font-bold animate-fade pointer-events-auto`;
                el.innerText = msg; c.appendChild(el); setTimeout(() => el.remove(), 3000);
            }
        };

        const Session = {
            async api(path, body) { try { const res = await fetch(`/api/${path}`, body ? {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)} : {}); return res.ok ? res.json() : null; } catch { return null; } },
            switch(id) { 
                if (State.user !== id) { 
                    State.user = id; 
                    State.status = 'OFFLINE'; 
                    State.qr = null; 
                    UI.renderSession(); 
                    this.check(); 
                } 
            },
            async start() { 
                State.status = 'INIT'; 
                UI.renderSession(); 
                await this.api('start', { id: State.user }); 
                setTimeout(() => this.poll(), 1000); 
            },
            async stop() { if(confirm("Disconnect?")) await this.api('logout', { id: State.user }); State.status='OFFLINE'; UI.renderSession(); },
            async check() { const data = await this.api(`status/${State.user}`); if (data) { State.status = data.status; State.qr = data.qr; UI.renderSession(); } },
            poll() { this.check(); setInterval(() => this.check(), 2000); }
        };

        const ContactManager = {
            async sync() {
                const btn = document.getElementById('btn-sync-contacts');
                const originalContent = btn.innerHTML;
                btn.innerHTML = `<span class="loader border-slate-600 border-b-transparent w-3 h-3"></span>`;
                
                const res = await Session.api(`contacts/${State.user}`);
                if (res && res.contacts) {
                    State.contacts = res.contacts;
                    State.contacts.sort((a, b) => (a.name || '').localeCompare(b.name || '')); // A-Z Sort
                    this.renderList(State.contacts);
                    Utils.toast(`Loaded ${res.count} contacts`, 'success');
                } else {
                    Utils.toast("Syncing in background... Retry in 10s", "info");
                }
                btn.innerHTML = originalContent;
                lucide.createIcons();
            },
            renderList(list) {
                const container = document.getElementById('contact-list-container');
                container.innerHTML = '';
                document.getElementById('stat-contacts').innerText = list.length;
                
                // Virtual Batch Rendering (Prevents Freezing)
                const BATCH_SIZE = 50;
                let currentIndex = 0;

                const renderBatch = () => {
                    const fragment = document.createDocumentFragment();
                    const end = Math.min(currentIndex + BATCH_SIZE, list.length);

                    for (let i = currentIndex; i < end; i++) {
                        const c = list[i];
                        const isSel = State.selection.has(c.number);
                        const div = document.createElement('div');
                        div.className = `contact-item flex items-center justify-between p-2 rounded-lg ${isSel ? 'selected' : ''}`;
                        div.onclick = () => this.toggle(c.number, div);
                        
                        const initial = (c.name && c.name.length > 0) ? c.name.charAt(0).toUpperCase() : '#';
                        const displayName = c.name || "Unknown";

                        div.innerHTML = `
                            <div class="flex items-center gap-3 pointer-events-none">
                                <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-xs font-bold text-slate-500 shrink-0">${initial}</div>
                                <div class="overflow-hidden">
                                    <h4 class="text-xs font-bold text-slate-700 truncate w-32">${displayName}</h4>
                                    <p class="text-[10px] text-slate-400 font-mono">${c.number}</p>
                                </div>
                            </div>
                            <div class="pointer-events-none w-4 h-4 rounded-full border border-slate-300 flex items-center justify-center text-[10px] ${isSel ? 'bg-brand-500 border-brand-500 text-white' : ''}">${isSel ? '✓' : ''}</div>
                        `;
                        fragment.appendChild(div);
                    }
                    container.appendChild(fragment);
                    currentIndex += BATCH_SIZE;
                    if (currentIndex < list.length) requestAnimationFrame(renderBatch);
                };
                renderBatch();
            },
            toggle(num, el) {
                if(State.selection.has(num)) State.selection.delete(num); else State.selection.add(num);
                el.classList.toggle('selected');
                const box = el.querySelector('div:last-child');
                box.className = `w-4 h-4 rounded-full border border-slate-300 flex items-center justify-center text-[10px] ${State.selection.has(num) ? 'bg-brand-500 border-brand-500 text-white' : ''}`;
                box.innerText = State.selection.has(num) ? '✓' : '';
                document.getElementById('sel-count').innerText = State.selection.size;
            },
            filter() {
                const q = document.getElementById('contact-search').value.toLowerCase();
                const qClean = q.replace(/\D/g, ''); // Clean number search
                const filtered = State.contacts.filter(c => 
                    (c.name && c.name.toLowerCase().includes(q)) || 
                    (c.number && c.number.includes(qClean))
                );
                this.renderList(filtered);
            },
            saveSelection() {
                const name = document.getElementById('new-list-name').value;
                if(!name || State.selection.size === 0) return Utils.toast("Enter name & select contacts", "error");
                const data = Array.from(State.selection).join('\n');
                localStorage.setItem(`nexus_list_${name}`, data);
                Utils.toast("List Saved", "success");
                this.clearSelection();
                Database.render();
            },
            clearSelection() {
                State.selection.clear();
                document.getElementById('sel-count').innerText = 0;
                document.getElementById('new-list-name').value = '';
                const allItems = document.querySelectorAll('.contact-item');
                allItems.forEach(el => {
                    el.classList.remove('selected');
                    el.querySelector('div:last-child').className = "w-4 h-4 rounded-full border border-slate-300 flex items-center justify-center text-[10px]";
                    el.querySelector('div:last-child').innerText = "";
                });
            }
        };

        const Import = {
            async loadGroups() {
                if(State.status !== 'READY') return Utils.toast("Connect WhatsApp first!", "error");
                const btn = document.getElementById('btn-load-groups'); const select = document.getElementById('group-selector');
                btn.innerText = `...`;
                try {
                    const res = await Session.api(`groups/${State.user}`);
                    select.innerHTML = '<option value="">Select List...</option>';
                    res.groups.forEach(g => { const opt = document.createElement('option'); opt.value = g.id; opt.innerText = `${g.name} (${g.count})`; select.appendChild(opt); });
                    select.disabled = false; select.classList.remove('bg-slate-50'); btn.innerText = `Loaded`;
                    select.onchange = () => { const on = !!select.value; document.getElementById('btn-import').disabled = !on; document.getElementById('btn-import').classList.toggle('opacity-50', !on); document.getElementById('btn-import').classList.toggle('cursor-not-allowed', !on); };
                    Utils.toast(`Found ${res.groups.length} lists`, "success");
                } catch(e) { Utils.toast("Error loading groups"); btn.innerText = `Retry`; }
            },
            async fetchSelected() {
                const grp = document.getElementById('group-selector');
                const btn = document.getElementById('btn-import');
                btn.innerText = `Importing...`;
                try {
                    const res = await Session.api(`get-members?id=${State.user}&groupJid=${encodeURIComponent(grp.value)}`);
                    const safeName = grp.options[grp.selectedIndex].text.split('(')[0].trim().replace(/[^a-z0-9]/gi, '_');
                    localStorage.setItem(`nexus_list_WA_${safeName}`, res.members.map(m=>m.number).join('\n'));
                    Utils.toast(`Imported ${res.count} contacts`, "success");
                    Database.render();
                } catch(e) { Utils.toast("Import failed"); } finally { btn.innerText = `Import Selected`; }
            }
        };

        const Database = {
            delete(key) { if(confirm("Delete list?")) { localStorage.removeItem(key); this.render(); } },
            loadList(val) { if(val) { document.getElementById('camp-input').value = localStorage.getItem(val); Utils.toast("List Loaded"); } },
            
            openEdit(key) {
                const content = localStorage.getItem(key);
                document.getElementById('edit-key-hidden').value = key;
                document.getElementById('edit-area').value = content;
                document.getElementById('modal-edit').classList.remove('hidden');
            },
            closeEdit() {
                document.getElementById('modal-edit').classList.add('hidden');
            },
            saveEdit() {
                const key = document.getElementById('edit-key-hidden').value;
                const content = document.getElementById('edit-area').value;
                localStorage.setItem(key, content);
                Utils.toast("List Updated", "success");
                this.closeEdit();
                this.render(); 
            },

            render() {
                const grid = document.getElementById('contact-grid'); const sel = document.getElementById('list-selector'); grid.innerHTML = ''; sel.innerHTML = '<option value="">Load List...</option>'; let total = 0;
                Object.keys(localStorage).forEach(k => {
                    if(k.startsWith('nexus_list_')) {
                        const name = k.replace('nexus_list_', ''); const count = (localStorage.getItem(k).match(/\n/g)||[]).length + 1; total += count;
                        const div = document.createElement('div'); div.className = "flex justify-between items-center p-2 border border-slate-100 rounded bg-slate-50";
                        div.innerHTML = `
                            <span class="text-xs font-bold text-slate-700 truncate w-20" title="${name}">${name} (${count})</span> 
                            <div class="flex gap-1">
                                <button onclick="Database.openEdit('${k}')" class="text-slate-400 hover:text-blue-500 p-1"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                                <button onclick="Database.delete('${k}')" class="text-slate-400 hover:text-red-500 p-1"><i data-lucide="trash" class="w-3 h-3"></i></button>
                            </div>
                        `;
                        grid.appendChild(div);
                        const opt = document.createElement('option'); opt.value = k; opt.innerText = name; sel.appendChild(opt);
                    }
                });
                lucide.createIcons();
            }
        };

        const Engine = {
            async handleFile(i) { if(i.files[0]) { document.getElementById('file-name').innerText = i.files[0].name; State.activeFile = await Utils.processFile(i.files[0]); } },
            queue() {
                const raw = document.getElementById('camp-input').value; const matches = raw.matchAll(/(?:\+?(\d{1,3}))?[-. (]*(\d{3})[-. )]*(\d{3})[-. ]*(\d{4})/g);
                for (const m of matches) { const num = m[0].replace(/\D/g, ''); if(num.length >= 10) State.queue.push({ number: num, msgs: [{ msg: document.getElementById('camp-msg').value, file: State.activeFile }] }); }
                document.getElementById('queue-count').innerText = State.queue.length; Utils.toast(`${State.queue.length} Queued`, "success");
            },
            toggle() { State.isRunning = !State.isRunning; document.getElementById('btn-engine-toggle').innerText = State.isRunning ? "PAUSE" : "START"; if(State.isRunning) this.process(); },
            clear() { State.queue=[]; document.getElementById('queue-count').innerText = 0; },
            async process() {
                if(!State.isRunning || State.queue.length === 0) { State.isRunning = false; document.getElementById('btn-engine-toggle').innerText = "START"; return; }
                const target = State.queue.shift(); document.getElementById('queue-count').innerText = State.queue.length;
                const log = document.getElementById('console-logs');
                log.prepend(Object.assign(document.createElement('div'), { className: "text-slate-500", innerText: `> Sending to ${target.number}...` }));
                await Session.api('send', { id: State.user, number: target.number, message: target.msgs[0].msg, file: target.msgs[0].file });
                log.prepend(Object.assign(document.createElement('div'), { className: "text-emerald-600", innerText: `> Sent` }));
                document.getElementById('stat-sent').innerText = ++State.processedCount;
                await Utils.sleep(Math.random() * 2000 + 1000); this.process();
            }
        };
        
        const Router = { go(p) { ['dashboard','campaigns','contacts','settings'].forEach(v => { document.getElementById(`view-${v}`).classList.add('hidden'); document.getElementById(`nav-${v}`).classList.remove('active'); }); document.getElementById(`view-${p}`).classList.remove('hidden'); document.getElementById(`nav-${p}`).classList.add('active'); document.getElementById('page-title').innerText = p.charAt(0).toUpperCase() + p.slice(1); } };
        const Settings = { save(k, v) { State.settings[k]=v; localStorage.setItem('nexus_settings', JSON.stringify(State.settings)); }, load(){ const s=localStorage.getItem('nexus_settings'); if(s) State.settings=JSON.parse(s); } };
        
        const UI = {
            renderSession() {
                const c1 = document.getElementById('btn-c1'); const c2 = document.getElementById('btn-c2');
                c1.className = State.user==='client-1' ? "node-btn active" : "node-btn inactive";
                c2.className = State.user==='client-2' ? "node-btn active" : "node-btn inactive";
                const dot = document.getElementById('conn-dot');
                const area = document.getElementById('action-area');
                const modal = document.getElementById('modal-qr');
                
                modal.classList.add('hidden');

                if (State.status === 'READY') {
                    dot.className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_#22c55e]";
                    area.innerHTML = `<button onclick="Session.stop()" class="w-full py-2 bg-white border border-red-200 text-red-500 hover:bg-red-50 text-xs font-bold rounded-lg transition-colors">Disconnect</button>`;
                } else if (State.status === 'QR_READY' && State.qr) {
                    dot.className = "w-2 h-2 rounded-full bg-blue-500 animate-pulse";
                    area.innerHTML = `<button onclick="document.getElementById('modal-qr').classList.remove('hidden')" class="w-full py-2 bg-brand-600 hover:bg-brand-700 text-white text-xs font-bold rounded-lg transition-colors">View QR Code</button>`;
                    modal.classList.remove('hidden');
                    new QRious({ element: document.getElementById('qr-canvas'), value: State.qr, size: 200 });
                } else if (State.status === 'INIT') {
                    dot.className = "w-2 h-2 rounded-full bg-amber-500 animate-ping";
                    area.innerHTML = `<button class="w-full py-2 bg-slate-100 text-slate-400 text-xs font-bold rounded-lg cursor-not-allowed flex justify-center gap-2"><span class="loader border-slate-300 border-b-slate-500"></span> Syncing...</button>`;
                } else {
                    dot.className = "w-2 h-2 rounded-full bg-slate-300";
                    area.innerHTML = `<button onclick="Session.start()" class="w-full py-2 bg-slate-800 hover:bg-slate-900 text-white text-xs font-bold rounded-lg transition-colors flex items-center justify-center gap-2"><i data-lucide="power" class="w-3 h-3"></i> Initialize</button>`;
                }
                lucide.createIcons();
            },
            updateQueue() { document.getElementById('queue-count').innerText = State.queue.length; document.getElementById('global-progress').style.width = State.queue.length > 0 ? "100%" : "0%"; }
        };

        Session.poll(); Database.render(); Settings.load(); UI.renderSession();
    </script>
</body>
</html>
